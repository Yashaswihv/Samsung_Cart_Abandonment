
-- (web_traffic is the traffic data provided by Rama)
-- Get the visits that contain atleas one cart as of a timeframe
drop table if exists cart_containing_visits;
select 
distinct visit_id 
into cart_containing_visits
from web_traffic 
where cart_session_id <>''
and event_date <= '2022-01-21';
create index id1 on cart_containing_visits(visit_id);

--For the above visits, get cross-sectional data 
drop table if exists yv_visit_level_all;
select a.visit_id, visitor_id, 
event_date as event_date_max    
, count(distinct case when cart_session_id <>'' then cart_session_id else null end) as cart_session_id_dist_cnt    , max(case when lower(page_name) like '%new ecom step2|checkout%' and lower(page_url) like '%express%' then 1 else 0 end) as checkout_exists  , sum(case when lower(page_name) like '%new ecom step2|checkout%' and lower(page_url) like '%express%' then 1 else 0 end) as checkout_cnt    , max(case when lower(page_name) like '%new ecom step1|view%cart%' and lower(page_url) like '%express%' then 1 else 0 end) as cart_visit_exists  , sum(case when lower(page_name) like '%new ecom step1|view%cart%' and lower(page_url) like '%express%' then 1 else 0 end) as cart_visit_cnt    , max(case when lower(page_name) like '%new ecom step3|thank%you%' then 1 else 0 end) as orderstq_exsits  , sum(case when lower(page_name) like '%new ecom step1|thank%you%' then 1 else 0 end) as orderstq_cnt    , count(distinct case when order_id <> '' then order_id else null end) as order_id_cnt_dist    , 1-max(case when cast(order_id as varchar) <> '' then 1 else 0 end) as cart_abandoned  , count(distinct case when cart_session_id <>'' then cart_session_id else null end) - count(distinct case when order_id <> '' then order_id else null end) as abandoned_cart_cnt      , max(device_type) as device_type_max  , count(distinct case when device_type <> '' then device_type else null end) as device_type_cnt_dist      , min(cast(visit_page_seq as int)) as visit_page_seq_min  , max(cast(visit_page_seq as int)) as visit_page_seq_max  , count(cast(visit_page_seq as int)) as visit_page_seq_cnt    , avg(case when page_event = 'pageview' then 1 else 0 end) as perc_pageview_page_event  , avg(case when page_event = 'click' then 1 else 0 end) as perc_click_page_event  , avg(case when page_event = '' then 1 else 0 end) as perc_no_page_event  , avg(case when page_event not in('', 'pageview', 'click') then 1 else 0 end) as perc_other_page_event    , sum(case when page_event = 'pageview' then 1 else 0 end) as pageview_page_event_cnt  , sum(case when page_event = 'click' then 1 else 0 end) as click_page_event_cnt  , sum(case when page_event = '' then 1 else 0 end) as no_page_event_cnt  , sum(case when page_event not in('', 'pageview', 'click') then 1 else 0 end) as other_page_event_cnt    , count(case when page_name <>'' then page_name else null end) as page_name_cnt  , count(case when page_name <>'' then page_name else null end) as page_name_cnt_dist    , max(case when entry_page=1 then page_name else null end) as entry_page_name  , max(case when exit_page=1 then page_name else null end) as exit_page_name    , count(case when page_name_v2 <>'' then page_name_v2 else null end) as page_name_v2_cnt  , count(case when page_name_v2 <>'' then page_name_v2 else null end) as page_name_v2_cnt_dist    , max(case when entry_page=1 then page_name_v2 else null end) as entry_page_name_v2  , max(case when exit_page=1 then page_name_v2 else null end) as exit_page_name_v2    , count(distinct case when product_id <> '' then product_id else null end) as product_id_cnt_dist      , count(distinct case when cid<>'' then cid else null end) as cid_cnt_dist    , max(cast(is_logged_in_flag as int)) as is_logged_in_flag_max  , avg(cast(is_logged_in_flag as int)) as is_logged_in_flag_perc    , min(event_time_est) as event_time_est_min  , max(event_time_est) as event_time_est_max  , max(event_time_est) - min(event_time_est) as visit_session_time    , max(cast(referrer as varchar)) as referrer_max  , count(distinct case when cast(referrer as varchar)<>'' then cast(referrer as varchar) else null end) as referrer_cnt_dist      , max(cast(bounce as int)) as bounce_max  , avg(cast(bounce as int)) as bounce_avg    , max(cast(entry_page as int)) as entry_page_max  , max(cast(exit_page as int)) as exit_page_max    , max(cast(va_closer_id as varchar)) as va_closer_id_max    , max(cast(program as varchar)) as program_max  , count(distinct case when cast(program as varchar)<>'' then cast(program as varchar) else null end) as program_cnt_dist    , max(cast(referral as varchar)) as referral_max  , count(distinct case when cast(referral as varchar)<>'' then cast(referral as varchar) else null end) as referral_cnt_dist    , max(cast(channel as varchar)) as channel_max  , count(distinct case when cast(channel as varchar)<>'' then cast(channel as varchar) else null end) as channel_cnt_dist    , max(cast(last_touch_channel as varchar)) as last_touch_channel_max  , count(distinct case when cast(last_touch_channel as varchar)<>'' then cast(last_touch_channel as varchar) else null end) as last_touch_channel_cnt_dist    , avg(cast(entry_page_seq as int)) as entry_page_seq_avg    , max(cast(visit_entry_channel as varchar)) as visit_entry_channel_max    , max(cast(visit_entry_channel_c360 as varchar)) as visit_entry_channel_c360_max    , avg(cast(b2c_flag as int)) as b2c_flag_avg    , avg(cast(checkout_flag as int)) as checkout_flag_avg    , count(case when cast(link_cat as varchar)<>'' then cast(link_cat as varchar) else null end) as link_cat_cnt  , count(case when cast(link_cat as varchar)<>'' then cast(link_cat as varchar) else null end) as link_cat_cnt_dist  , max(case when entry_page=1 then link_cat else null end) as entry_link_cat  , max(case when exit_page=1 then link_cat else null end) as exit_link_cat    , count(case when cast(link_id as varchar)<>'' then cast(link_id as varchar) else null end) as link_id_cnt  , count(case when cast(link_id as varchar)<>'' then cast(link_id as varchar) else null end) as link_id_cnt_dist  , max(case when entry_page=1 then link_id else null end) as entry_link_id  , max(case when exit_page=1 then link_id else null end) as exit_link_id    , count(case when cast(event_name as varchar)<>'' then cast(event_name as varchar) else null end) as event_name_cnt  , count(case when cast(event_name as varchar)<>'' then cast(event_name as varchar) else null end) as event_name_cnt_dist  , max(case when entry_page=1 then event_name else null end) as entry_event_name  , max(case when exit_page=1 then event_name else null end) as exit_event_name    , max(cast(browser_name as varchar)) as browser_name_max  , max(cast(site_txmy2 as varchar)) as site_txmy2_max    , avg(cast(new_visit_flag as int)) as new_visit_flag_avg      , max(cast(platform as varchar)) as platform_max  , max(cast(test_Type as varchar)) as test_Type_max  , max(cast(product_modelcode as varchar)) as product_modelcode_max  , max(cast(event_time as varchar)) as event_time_max    , avg(cast(b2b_flag as int)) as b2b_flag_avg    , count(distinct case when cast(paymentmethod as varchar)<>'' then cast(paymentmethod as varchar) else null end) as paymentmethod_cnt_dist    , count(distinct case when cast(finalpayment as varchar)<>'' then cast(finalpayment as varchar) else null end) as finalpayment_cnt_dist    , count(distinct case when lower(cast(page_type as varchar)) like '%404 page not found' then lower(cast(page_type as varchar)) else null end) as page_type_404_dist_cnt  , max(case when entry_page=1 then page_type else null end) as entry_page_type  , max(case when exit_page=1 then page_type else null end) as exit_page_type 
into yv_visit_level_all from web_traffic a 
inner join cart_containing_visits b on b.visit_id = a.visit_id
where a.event_date <= '2022-01-21'
group by   a.visit_id  , visitor_id, event_date;

-- Create the visit level - FLAGS for various kinds of activities 
drop table if exists yv_visit_level_FLAGS; 
select a.visit_id, a.visitor_id 
, event_date as event_date_max 
, max(case when lower(a.link_track_txmy3) like '%web/express/cart>%>save for later%' or a.event_name = 'cart_save_for_later' then 1 else 0 end) as save_for_later , max(case when lower(a.link_track_txmy3) like '%home>continue_header_%' or a.event_name like 'select_home_continue_header_%' then 1 else 0 end) as continue_btn , max(case when lower(a.link_track_txmy3) like '%accessories>recommended_view_%' or a.event_name like 'select_accessories_recommended_view_%' then 1 else 0 end) as recommended_items , max(case when lower(a.link_track_txmy3) like '%customers also bought add to cart_true%' or a.event_name = 'cart_adobe_recommended_item_add_to_cart' then 1 else 0 end) as FBT_Addtocart , max(case when lower(a.event_name) = 'select_cart_click' then 1 else 0 end) as top_cart_clicked , max(case when lower(a.event_name) = 'select_accessories_skip add-ons' then 1 else 0 end) as skip_addons , max(case when lower(a.link_track_txmy3) like '%/us/smartphones/%' then 1 else 0 end) as smartphone_sessions , max(case when lower(a.link_track_txmy3) like '%/us/televisions%/%' then 1 else 0 end) as he_sessions , max(case when lower(a.link_track_txmy3) like '%/us/home-appliances%' then 1 else 0 end) as ha_sessions , max(case when lower(a.link_track_txmy3) like '%/us/computing%' then 1 else 0 end) as comp_sessions , max(case when a.is_logged_in_flag = 1 then 1 else 0 end) as logged_in_session , max(case when a.is_logged_in_flag = 0 then 1 else 0 end) as not_logged_in_session , count(distinct(case when lower(a.page_name) = 'new ecom step2|checkout' then a.visit_id end)) as Checkout                 , count(distinct(case when lower(a.page_name) = 'new ecom step1|view cart' then a.visit_id end)) as View_Cart , max(case when lower(a.event_name) = 'select_carrier_att' then 1 else 0 end) as 			select_att , max(case when lower(a.event_name) = 'select_carrier_t-mobile' then 1 else 0 end) as 		select_tmo , max(case when lower(a.event_name) = 'select_carrier_unlocked' then 1 else 0 end) as 		select_Unlocked , max(case when lower(a.event_name) = 'select_carrier_sprint' then 1 else 0 end) as 		select_sprint , max(case when lower(a.event_name) = 'select_carrier_tracfone' then 1 else 0 end) as 		select_tracfone , max(case when lower(a.event_name) = 'select_carrier_us-cellular' then 1 else 0 end) as 	select_usc , max(case when lower(a.event_name) = 'select_carrier_verizon' then 1 else 0 end) as 		select_vzw , count(distinct(case when lower(a.page_name) = 'new ecom step2|checkout' and upper(a.product_id) like '%SM-%VZW%' then a.visit_id end)) as Checkout_vzw , count(distinct(case when lower(a.page_name) = 'new ecom step2|checkout' and upper(a.product_id) like '%SM-%ATT%' then a.visit_id end)) as Checkout_att , count(distinct(case when lower(a.page_name) = 'new ecom step2|checkout' and upper(a.product_id) like '%SM-%TMO%' then a.visit_id end)) as Checkout_tmo , count(distinct(case when lower(a.page_name) = 'new ecom step2|checkout' and upper(a.product_id) like '%SM-%XAU%' then a.visit_id end)) as Checkout_tmo2 , count(distinct(case when lower(a.page_name) = 'new ecom step2|checkout' and upper(a.product_id) like '%SM-%XAA%' then a.visit_id end)) as Checkout_xaa , count(distinct(case when (lower(a.page_name) = 'new ecom step3|thankyou' and upper(a.product_id) like '%SM-%VZW%' and a.order_id is not null) then order_id end)) as Orders_vzw , count(distinct(case when (lower(a.page_name) = 'new ecom step3|thankyou' and upper(a.product_id) like '%SM-%ATT%' and a.order_id is not null) then order_id end)) as Orders_att , count(distinct(case when (lower(a.page_name) = 'new ecom step3|thankyou' and upper(a.product_id) like '%SM-%TMO%' and a.order_id is not null) then order_id end)) as Orders_tmo , count(distinct(case when (lower(a.page_name) = 'new ecom step3|thankyou' and upper(a.product_id) like '%SM-%XAU%' and a.order_id is not null) then order_id end)) as Orders_tmo2 , count(distinct(case when (lower(a.page_name) = 'new ecom step3|thankyou' and upper(a.product_id) like '%SM-%XAA%' and a.order_id is not null) then order_id end)) as Orders_xaa , count(distinct(case when lower(a.page_name) = 'new ecom step1|view cart' and upper(a.product_id) like '%SM-%VZW%' then a.visit_id end)) as View_Cart_vzw , count(distinct(case when lower(a.page_name) = 'new ecom step1|view cart' and upper(a.product_id) like '%SM-%ATT%' then a.visit_id end)) as View_Cart_att , count(distinct(case when lower(a.page_name) = 'new ecom step1|view cart' and upper(a.product_id) like '%SM-%TMO%' then a.visit_id end)) as View_Cart_tmo , count(distinct(case when lower(a.page_name) = 'new ecom step1|view cart' and upper(a.product_id) like '%SM-%XAU%' then a.visit_id end)) as View_Cart_tmo2 , count(distinct(case when lower(a.page_name) = 'new ecom step1|view cart' and upper(a.product_id) like '%SM-%XAA%' then a.visit_id end)) as View_Cart_xaa , max(case when lower(a.link_track_txmy3) like '%us/%web%express%cart%customers%add%to%cart%' then 1 else 0 end) as add_recommended_product , max(case when lower(a.link_track_txmy3) like '%/web%express%cart%update quantity> 1%' then 1 else 0 end) as update_quantity , max(case when lower(a.link_track_txmy3) like '%/web%express%cart%remove from cart%' then 1 else 0 end) as remove_quantity , max(case when lower(a.link_track_txmy3) like '%us/%web%express%>order summary>apply promo code%' then 1 else 0 end) as apply_promo_code , max(case when lower(a.link_track_txmy3) like '%/web%express%cart>cart>checkout%' then 1 else 0 end) as click_on_checkout_from_cart , max(case when lower(a.link_track_txmy3) like '%/web%express%cart%invalid%error_message%' then 1 else 0 end) as error_message_cart , max(case when lower(a.link_track_txmy3) like '%/web/express/cart>Samsung Checkout%alert_%' then 1 else 0 end) as alert_message_cart , max(case when lower(a.link_track_txmy3) like '%/web%express%cart%remove from cart%' then 1 else 0 end) as cart_remove_item , max(case when lower(a.link_track_txmy3) like '%/web%express%>checkout>sign in%' then 1 else 0 end) as click_on_signin , max(case when lower(a.event_name) like '%checkout_select_creditcard%' then 1 else 0 end) as wallet_card , max(case when lower(a.event_name) like '%checkout_payment_enter_cc%' then 1 else 0 end) as enter_new_credit_CC , max(case when lower(a.event_name) like '%payment%information%change%' then 1 else 0 end) as payment_information_chg , max(case when lower(a.event_name) like '%checkout select in-store%' then 1 else 0 end) as in_store , max(case when lower(a.event_name) like '%pickup%delivery options%' then 1 else 0 end) as change_delivery , max(case when lower(a.event_name) like '%checkout delivery for zipcode%' then 1 else 0 end) as delivery_to_zipcode , max(case when lower(a.event_name) like '%checkout zipcode change%' then 1 else 0 end) as change_zipcode , max(case when lower(a.link_track_txmy3) like '%/web%express%cart>cart>change zip code%' then 1 else 0 end) as cart_change_zip_code , max(case when lower(a.link_track_txmy3) like '%/web%express%cart>cart>zip code>apply%' then 1 else 0 end) as cart_zip_code_apply , max(case when lower(a.link_track_txmy3) like '%/web%express%>payment information>enter zip%' then 1 else 0 end) as enter_zip_code , max(case when lower(a.link_track_txmy3) like '%/web%express%>payment information>enter state%' then 1 else 0 end) as enter_state , max(case when lower(a.link_track_txmy3) like '%/web%express%>shipping information>change%' then 1 else 0 end) as change_shipping_address , max(case when lower(a.link_track_txmy3) like '%/web%express%checkout>%redeemed%invalid%error_message%' then 1 else 0 end) as error_message_checkout , max(case when lower(a.link_track_txmy3) like '%payment information>payment information continue%' then 1 else 0 end) as payment_details_complete , max(case when lower(a.link_track_txmy3) like '%/web%express%>payment information>enter credit card%' then 1 else 0 end) as enter_credit_card_details , max(case when lower(a.link_track_txmy3) like '%/web%express%payment information>payment method>security code>tooltip%' then 1 else 0 end) as click_on_cvv_tooltip , max(case when lower(a.link_track_txmy3) like '%/web%express/cart>payment information>add payment method>creditcard%' then 1 else 0 end) as add_Credit_Card , max(case when lower(a.link_track_txmy3) like '%/web%express%shipping%method>exped%' then 1 else 0 end) as expedited_shipping , max(case when lower(a.link_track_txmy3) like '%/web%express%shipping%method>express%' then 1 else 0 end) as express_shipping , max(case when lower(a.link_track_txmy3) like '%/web%express%shipping%method>standard%' then 1 else 0 end) as standard_shipping , max(case when lower(a.link_track_txmy3) like '%/web%express%>place order%' then 1 else 0 end) as click_on_place_order_button , max(case when lower(a.link_track_txmy3) like '%web%express%samsung financing%pay over time%' then 1 else 0 end) as Pay_over_time , max(case when lower(a.link_track_txmy3) like '%web%express%eip%pay%time%' then 1 else 0 end) as EIP , max(case when lower(a.link_track_txmy3) like '%web%express%deferred%pay%ime%' then 1 else 0 end) as Defferred , max(case when lower(a.link_track_txmy3) like '%web%express%cart%samsung%financing%36_mo_eip_0_apr%pay%over%time%' then 1 else 0 end) as n36_mo_eip , max(case when lower(a.link_track_txmy3) like '%web%express%checkout%samsung%financing%24_mo_eip_0_apr%pay%over%time%' then 1 else 0 end) as n24_mo_eip , max(case when lower(page_url) like '%/express%' and page_name_v2 like '%checkout-finance%' and page_name = 'finance application' then 1 else 0 end) as financing_application , max(case when lower(a.page_name) LIKE '%new ecom step2|checkout%' and lower(page_url) like '%/express%' and page_name_v2 like '%td denied%' and raw_page_state NOT like 'state4.1|Checkout%ReturningUser%' then 1 else 0 end) as td_denied_new , max(case when lower(a.page_name) LIKE '%new ecom step2|checkout%' and lower(page_url) like '%/express%' and page_name_v2 like '%td denied%' and raw_page_state like 'state4.1|Checkout%ReturningUser%' then 1 else 0 end) as td_denied_returned , max(case when lower(a.page_name) LIKE '%new ecom step2|checkout%' and lower(page_url) like '%/express%' and page_name_v2 like '%td approved%' and raw_page_state NOT like 'state4.1|Checkout%ReturningUser%' then 1 else 0 end) as td_approved_new , max(case when lower(a.page_name) LIKE '%new ecom step2|checkout%' and lower(page_url) like '%/express%' and page_name_v2 like '%td approved%' and raw_page_state like 'state4.1|Checkout%ReturningUser%' then 1 else 0 end) as td_approved_retuned , max(case when lower(a.page_name) LIKE '%new ecom step2|checkout%' and lower(page_url) like '%/express%' and page_name_v2 like '%td refer%' then 1 else 0 end) as td_refer , max(case when lower(a.page_name) LIKE '%new ecom step2|checkout%' and lower(page_url) like '%/express%' and page_name_v2 like '%td not enough credit%' then 1 else 0 end) as td_not_enough_credit , max(case when lower(a.link_track_txmy3) like '%/web%express%payment information> apply for affirm loan%' then 1 else 0 end) as Apply_for_Affirm_Loan , max(case when lower(a.link_track_txmy3) like '%/web/express/checkout>affirm split4>star%' then 1 else 0 end) as Apply_for_Affirm_split4_Loan , max(case when lower(a.link_track_txmy3) like '%/web/express/checkout>checkout>congratulation prequalified for affirm>cont%' then 1 else 0 end) as waterfall_entering , max(case when lower(a.link_track_txmy3) like '%finance application%choose address>original%' then 1 else 0 end) as Choose_Address_Original , max(case when lower(a.link_track_txmy3) like '%finance application%choose address>suggested%' then 1 else 0 end) as Choose_Address_Suggested , max(case when lower(a.link_track_txmy3) like '%/web%express%>finance application%submit application%' then 1 else 0 end) as Submit_application , max(case when lower(a.link_track_txmy3) like '%web/express%paypal%' then 1 else 0 end) as payment_paypal , max(case when lower(a.link_track_txmy3) like '%/web/%>paypal success%' then 1 else 0 end) as paypal_success , max(case when lower(a.link_track_txmy3) like '%/us/%web%express%google pay%' then 1 else 0 end) as payment_google_pay , max(case when lower(a.link_track_txmy3) like '%/web/%>google pay>back%' then 1 else 0 end) as google_pay_back_button , max(case when lower(a.link_track_txmy3) like '%/web/%>google pay>success%' then 1 else 0 end) as google_pay_success , max(case when lower(a.link_track_txmy3) like '%express%amazon pay%' then 1 else 0 end) as amazonpay , max(case when lower(a.link_track_txmy3) like '%amazon pay>continue to shipping%' then 1 else 0 end) as amazonpay_continue_shipping , max(case when lower(a.link_track_txmy3) like '%amazon pay>update and continue%' then 1 else 0 end) as amazonpay_update , max(case when lower(a.link_track_txmy3) like '%checkout>amazon pay success%' then 1 else 0 end) as amazonpay_success , max(case when lower(a.link_track_txmy3) like '%express/cart%checkout>samsung%pay%' then 1 else 0 end) as samsungpay , max(case when lower(a.link_track_txmy3) like '%express/checkout>>continue to samsung pay%' then 1 else 0 end) as samsungpay_continue , max(case when lower(a.link_track_txmy3) like '%/us/%web%express%apple pay%' then 1 else 0 end) as payment_apple_pay , max(case when lower(a.link_track_txmy3) like '%/web/%>apple pay>success%' then 1 else 0 end) as apple_pay_success , max(case when lower(a.link_track_txmy3) like '%/web/%>apple pay>fail%' then 1 else 0 end) as apple_pay_fail , max(case when lower(a.link_track_txmy3) like '%reward points> apply%' then 1 else 0 end) as rewards_apply , max(case when lower(a.link_track_txmy3) like '%web/express/cart>order summary>apply promo code%' then 1 else 0 end) as promocode_apply , max(case when lower(a.link_track_txmy3) like '%web/express/checkout%InvalidCouponCode%' then 1 else 0 end) as invalid_coupon , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>progressive%leasing>start%' then 1 else 0 end) as lto_leasing_start , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>progressive%leasing>continue%' then 1 else 0 end) as lto_leasing_cont , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>progressive%leasing>close%' then 1 else 0 end) as lto_leasing_close , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>payment%schedule>start%' then 1 else 0 end) as payment_schedule_start , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>payment%schedule>close%' then 1 else 0 end) as payment_schedule_close , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>payment%schedule>payment_frequency0%' then 1 else 0 end) as payment_schedule_option0_selected , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>payment%schedule>payment_frequency1%' then 1 else 0 end) as payment_schedule_option1_selected , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>payment%schedule>payment_frequency2%' then 1 else 0 end) as payment_schedule_option2_selected , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>payment%schedule_terms>agree%' then 1 else 0 end) as payment_schedule_agree_TnC , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>payment%schedule_marketing>agree%' then 1 else 0 end) as payment_schedule_agree_marketing , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>credit%card>start%' then 1 else 0 end) as credit_card_start , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>credit%card>close%' then 1 else 0 end) as credit_card_close , max( case when lower(a.link_track_txmy3) like '%us/web%checkout>lto>credit%card>continue%to%lease%signing%' then 1 else 0 end) as credit_card_continue_lease_signing , max(case when lower(a.page_name) LIKE '%us/mweb/carrier/financing%' then 1 else 0 end) as carrier_finance_landing_mweb , max(case when lower(a.page_name) LIKE '%us/web/carrier/financing%' then 1 else 0 end) as carrier_finance_landing_web , max(case when (lower(a.page_name) LIKE '%activation signin entry%' or lower(a.page_name_v2) LIKE '%activation signin entry%' ) then 1 else 0 end) as carrier_activation_landing , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%activation signin entry>don%have an account%' then 1 else 0 end) as login_dont_have_an_account , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%activation lineoption>add new line%' then 1 else 0 end) as add_new_line , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%activation lineoption>upgrade existing line%' then 1 else 0 end) as upgrade_existing_line , max(case when (lower(a.page_name) LIKE '%activation application creditcheck%' or lower(a.page_name_v2) LIKE '%activation application creditcheck%' ) then 1 else 0 end) as carrier_activation_finance_application_landing , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%activation signin coveragecheck>continue%' then 1 else 0 end) as zip_code_coverage , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%carrier financing application>enter fname%' then 1 else 0 end) as entering_first_name , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%carrier financing application>enter zipcode%' then 1 else 0 end) as enter_zip_code_cf , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%carrier financing application>enter ssn%' then 1 else 0 end) as enter_ssn , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%application term and condition>agree%' then 1 else 0 end) as agreeing_t_and_c , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%activation application creditcheck>submit application' then 1 else 0 end) as submitting_finance_application , max(case when (lower(a.page_name) LIKE '%carrierfinancing_number_new%' or lower(a.page_name_v2) LIKE '%carrierfinancing_number_new%' ) then 1 else 0 end) as number_activation_page , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%activation number>new number' then 1 else 0 end) as new_number , max(case when (lower(a.page_name) LIKE '%activation plans carrierplanselection%' or lower(a.page_name_v2) LIKE '%activation plans carrierplanselection%' ) then 1 else 0 end) as plan_selection_page , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%plan selection>%true>ro%' then 1 else 0 end) as select_plan , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%carrier financing%login%open' then 1 else 0 end) as login_open , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%carrier financing%login%success' then 1 else 0 end) as login_success , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%carrier financing%login%close' then 1 else 0 end) as login_popup_close , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%legal agreements>agree%' then 1 else 0 end ) as carrier_agreement , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%carrier financing%error_message%' then 1 else 0 end) as error_event , max(case when lower(a.link_track_txmy3) like '%carrier-activation/financing%continue to checkout%' then 1 else 0 end) as continue_to_checkout 
into yv_visit_level_FLAGS 
from web_traffic a 
inner join cart_containing_visits b 
on b.visit_id = a.visit_id 
where a.event_date <= '2022-01-21' group by   a.visit_id  , visitor_id, event_date;

--Get the First occuring product in the Visit-cart
drop table if exists yv_visit_level_prod;
select a.visit_id, visitor_id
, max(event_date) as event_date_max
, max(case 
when len(substring(product_id, 1, charindex(',', product_id, 1))) >0 then substring(product_id, 1, charindex(',', product_id, 1)) 
when len(substring(product_id, 1, charindex(',', product_id, 1))) = 0 then concat(product_id, ',') end ) as product_id_max
into yv_visit_level_prod from web_traffic a   
inner join cart_containing_visits b on b.visit_id = a.visit_id
where a.event_date <= '2022-01-21'
group by   a.visit_id  , visitor_id;


--From the crossectional data, create VISIT SEGMENT
--------------------------------------------------------
drop table yv_cust_seg_1;
SELECT 
visit_id, visitor_id, event_date_max, 
(pageview_page_event_cnt*1.00) / (visit_page_seq_max*1.00) AS click_depth,
visit_session_time AS session_time,
CASE WHEN channel_max = 'direct' THEN 1 ELSE 0 END AS Brand,
CASE WHEN new_visit_flag_avg = 0 THEN 1 ELSE 0 END AS loyalty,
CASE WHEN is_logged_in_flag_max = 1 THEN 1 ELSE 0 END AS subscription
into yv_cust_seg_1
FROM 
yv_visit_level_all a

drop table yv_cust_seg_2;
SELECT 
visit_id, visitor_id, event_date_max, 
(((CASE WHEN click_depth > 2.263125888259900149 THEN 1.00 ELSE 0 END + 
CASE WHEN session_time > cast('1900-01-01 00:02:42.000' as datetime) THEN 1.00 ELSE 0 END + 
CASE WHEN Brand = 1 THEN 1.00 ELSE 0 END + 
CASE WHEN loyalty = 1 THEN 1.00 ELSE 0 END + 
CASE WHEN subscription = 1 THEN 1.00 ELSE 0 END) / 5.00 ) * 100) as score
into yv_cust_seg_2
FROM 
yv_cust_seg_1

drop table yv_cust_seg_3;
SELECT 
visit_id, visitor_id, event_date_max, 
CASE WHEN ((score >= 0) AND (score <= 20)) THEN 'non_engagers' 
WHEN ((score >= 21) AND (score <= 60)) THEN 'somewhat_engagers' 
WHEN ((score >= 61) AND (score <= 100)) THEN 'engagers' ELSE NULL END AS visitor_type
into yv_cust_seg_3
FROM 
yv_cust_seg_2
--------------------------------------------------------




-- Optional Run-- From the cross-section data, we ran the modl to finally arrive at some important variables which we select into another table 
drop table yv_visit_level_all_1;
select 
concat(visit_id, cast(event_date_max as varchar(10))) as visit_id_day
, visit_id
, event_date_max
, visitor_id
, cart_session_id_dist_cnt 
, cart_abandoned
, abandoned_cart_cnt
, cart_visit_cnt
, visit_session_time
, pageview_page_event_cnt 
, exit_link_cat 
, site_txmy2_max 
, exit_page_name_v2
, event_name_cnt_dist 
, event_name_cnt 
, referrer_max 
, click_page_event_cnt 
, test_Type_max 
, visit_page_seq_max 
, visit_entry_channel_c360_max
, exit_page_type
, channel_max
, entry_page_type
, event_time_est_min
, event_time_est_max
, new_visit_flag_avg
, is_logged_in_flag_max
, product_id_cnt_dist
, datename(weekday, event_date_max) as wk_day
, datepart(hour, event_time_est_min) as hr
, ROW_NUMBER() over(partition by visit_id order by event_date_max) as nth_day_visit
into yv_visit_level_all_1
from yv_visit_level_all 
where b2b_flag_avg=0 
and product_id_cnt_dist>0
and event_date_max <= '2022-01-21'


-- Join product details, FLAGS to the above data
drop table if exists yv_visit_level_all_2;
select a.*
, replace(b.product_id_max, ',', '') as product_id_max
, c.save_for_later , c.continue_btn , c.recommended_items , c.FBT_Addtocart , c.top_cart_clicked , c.skip_addons , c.smartphone_sessions , c.he_sessions , c.ha_sessions , c.comp_sessions , c.logged_in_session , c.not_logged_in_session , c.Checkout , c.View_Cart , c.select_att , c.select_tmo , c.select_Unlocked , c.select_sprint , c.select_tracfone , c.select_usc , c.select_vzw , c.Checkout_vzw , c.Checkout_att , c.Checkout_tmo , c.Checkout_tmo2 , c.Checkout_xaa , c.Orders_vzw , c.Orders_att , c.Orders_tmo , c.Orders_tmo2 , c.Orders_xaa , c.View_Cart_vzw , c.View_Cart_att , c.View_Cart_tmo , c.View_Cart_tmo2 , c.View_Cart_xaa , c.add_recommended_product , c.update_quantity , c.remove_quantity , c.apply_promo_code , c.click_on_checkout_from_cart , c.error_message_cart , c.alert_message_cart , c.cart_remove_item , c.click_on_signin , c.wallet_card , c.enter_new_credit_CC , c.payment_information_chg , c.in_store , c.change_delivery , c.delivery_to_zipcode , c.change_zipcode , c.cart_change_zip_code , c.cart_zip_code_apply , c.enter_zip_code , c.enter_state , c.change_shipping_address , c.error_message_checkout , c.payment_details_complete , c.enter_credit_card_details , c.click_on_cvv_tooltip , c.add_Credit_Card , c.expedited_shipping , c.express_shipping , c.standard_shipping , c.click_on_place_order_button , c.Pay_over_time , c.EIP , c.Defferred , c.n36_mo_eip , c.n24_mo_eip , c.financing_application , c.td_denied_new , c.td_denied_returned , c.td_approved_new , c.td_approved_retuned , c.td_refer , c.td_not_enough_credit , c.Apply_for_Affirm_Loan , c.Apply_for_Affirm_split4_Loan , c.waterfall_entering , c.Choose_Address_Original , c.Choose_Address_Suggested , c.Submit_application , c.payment_paypal , c.paypal_success , c.payment_google_pay , c.google_pay_back_button , c.google_pay_success , c.amazonpay , c.amazonpay_continue_shipping , c.amazonpay_update , c.amazonpay_success , c.samsungpay , c.samsungpay_continue , c.payment_apple_pay , c.apple_pay_success , c.apple_pay_fail , c.rewards_apply , c.promocode_apply , c.invalid_coupon , c.lto_leasing_start , c.lto_leasing_cont , c.lto_leasing_close , c.payment_schedule_start , c.payment_schedule_close , c.payment_schedule_option0_selected , c.payment_schedule_option1_selected , c.payment_schedule_option2_selected , c.payment_schedule_agree_TnC , c.payment_schedule_agree_marketing , c.credit_card_start , c.credit_card_close , c.credit_card_continue_lease_signing , c.carrier_finance_landing_mweb , c.carrier_finance_landing_web , c.carrier_activation_landing , c.login_dont_have_an_account , c.add_new_line , c.upgrade_existing_line , c.carrier_activation_finance_application_landing , c.zip_code_coverage , c.entering_first_name , c.enter_zip_code_cf , c.enter_ssn , c.agreeing_t_and_c , c.submitting_finance_application , c.number_activation_page , c.new_number , c.plan_selection_page , c.select_plan , c.login_open , c.login_success , c.login_popup_close , c.carrier_agreement , c.error_event , c.continue_to_checkout 
into yv_visit_level_all_2
from yv_visit_level_all_1 a 
inner join yv_visit_level_prod b 
on b.visit_id = a.visit_id and b.visitor_id = a.visitor_id and b.event_date_max = a.event_date_max
inner join yv_visit_level_FLAGS c
on c.visit_id = a.visit_id and c.visitor_id = a.visitor_id and c.event_date_max = a.event_date_max
where 
a.event_date_max <= '2022-01-21'
and b.event_date_max <='2022-01-21'
and c.event_date_max <='2022-01-21'


-- Join the customer segments with visits and pull the data for modeling and dashboarding
select 
a.*
, b.visitor_type
, c.click_depth
, c.Brand
, c.loyalty
, substring(a.visit_id, charindex('-', a.visit_id, 1)+1, len(a.visit_id)) as nth_visit_of_visitor
into yv_Final
from yv_visit_level_all_2 a
inner join 
yv_cust_seg_3 b 
on b.visit_id = a.visit_id and b.visitor_id = a.visitor_id and b.event_date_max = a.event_date_max
inner join 
yv_cust_seg_1 c 
on c.visit_id = a.visit_id and c.visitor_id = a.visitor_id and c.event_date_max = a.event_date_max
and a.event_date_max <= '2022-01-21'




